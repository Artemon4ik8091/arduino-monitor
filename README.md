# Информационный Дисплей на Arduino и Python

Этот проект представляет собой систему, которая отображает различную информацию (системные показатели, сетевые данные, погоду, статус Яндекс.Музыки) на LCD-дисплее, подключенном к Arduino, управляемом Python-скриптом, запущенным на мини-ПК (например, Raspberry Pi).

## 1\. Обзор Проекта

Проект состоит из двух основных частей:

  * **Python-скрипт (на мини-ПК):** Отвечает за сбор данных из различных источников (системные ресурсы, сетевая информация, OpenWeatherMap API, Яндекс.Музыка API) и отправку их по последовательному порту на Arduino. Он также выполняет транслитерацию русского текста для корректного отображения на LCD.
  * **Arduino-скетч (на микроконтроллере):** Получает данные по последовательному порту от Python-скрипта и управляет LCD-дисплеем для их отображения. (Примечание: Код Arduino-скетча не был предоставлен и в этой документации описана только его предполагаемая функциональность на основе взаимодействия с Python-скриптом).

## 2\. Python-скрипт

### 2.1. Назначение

Python-скрипт является "мозгом" системы. Он выполняет следующие функции:

  * **Сбор системных метрик:** Процент загрузки CPU, использование RAM, использование диска.
  * **Получение сетевой информации:** SSID Wi-Fi сети и IP-адрес.
  * **Запрос данных о погоде:** Получает текущую погоду и температуру с OpenWeatherMap API.
  * **Мониторинг Яндекс.Музыки:** Получает информацию о текущем воспроизводимом треке (исполнитель, название), его статусе (играет/пауза) с помощью Яндекс.Музыки API.
  * **Транслитерация:** Преобразует русские символы в латиницу для совместимости с LCD-дисплеем, поскольку большинство таких дисплеев не поддерживают кириллицу напрямую.
  * **Форматирование данных:** Подготавливает строки данных для вывода на 16-символьный 2-строчный LCD.
  * **Последовательная связь:** Отправляет отформатированные данные на Arduino по последовательному порту.
  * **Обработка команд от Arduino:** Слушает команды от Arduino (например, запросы на обновление погоды или системных данных) и реагирует на них.
  * **Режимы отображения:** Автоматически переключает режимы отображения на LCD в зависимости от статуса воспроизведения Яндекс.Музыки:
      * **Режим "Музыка играет":** На первой строке компактная дата/время и температура, на второй – прокручиваемое название трека/исполнителя (транслитерированное).
      * **Режим "Ожидание" (музыка не играет или на паузе):** На первой строке полная дата/время, на второй – информация о погоде.

### 2.2. Зависимости

Для работы Python-скрипта необходимо установить следующие библиотеки:

  * `pyserial`: Для взаимодействия с последовательным портом (Arduino).
  * `psutil`: Для получения системных метрик.
  * `requests`: Для HTTP-запросов к OpenWeatherMap API.
  * `aiohttp`: Для асинхронных HTTP-запросов (используется библиотекой yandex-music).
  * `yandex-music`: Для взаимодействия с Яндекс.Музыкой API.

Вы можете установить их с помощью `pip`:

```bash
pip install pyserial psutil requests aiohttp yandex-music
```

### 2.3. Конфигурация

Перед запуском скрипта необходимо настроить следующие параметры в файле `display_controller.py`:

  * **`arduino_port`**: Строка, указывающая на последовательный порт, к которому подключен Arduino. Для Linux это часто `/dev/ttyACM0` или `/dev/ttyUSB0`.
  * **`baud_rate`**: Скорость передачи данных по последовательному порту. Должна совпадать со скоростью, установленной в Arduino-скетче (по умолчанию 9000).
  * **`OPENWEATHER_API_KEY`**: Ваш API-ключ для OpenWeatherMap. Получить его можно после регистрации на [OpenWeatherMap](https://openweathermap.org/api).
  * **`CITY_ID`**: ID вашего города для OpenWeatherMap. Вы можете найти его в файле со списком городов.
  * **`YANDEX_MUSIC_TOKEN`**: Ваш авторизационный токен для Яндекс.Музыки. Инструкции по его получению можно найти здесь: [Получение токена Яндекс.Музыки](https://github.com/MarshalX/yandex-music-api/discussions/513#discussioncomment-2729781).
  * **`MUSIC_API_CHECK_INTERVAL_SEC`**: Интервал в секундах, с которым скрипт будет опрашивать API Яндекс.Музыки для обновления статуса трека.
  * **`MUSIC_SCROLL_SPEED_SEC`**: Интервал в секундах, с которым будет происходить смещение текста при прокрутке названия трека. Меньшее значение = более быстрая прокрутка (например, `0.2` для быстрой прокрутки).
  * **`WEATHER_UPDATE_INTERVAL_MINUTES`**: Интервал в минутах, с которым будет обновляться информация о погоде.
  * **`IDLE_DATA_SEND_INTERVAL_SEC`**: Интервал в секундах, с которым данные будут отправляться на Arduino в режиме ожидания (для поддержания актуальности экрана).

**Пример конфигурации в коде:**

```python
arduino_port = "/dev/ttyACM0" 
baud_rate = 9000               

OPENWEATHER_API_KEY = "ВАШ_API_КЛЮЧ_ЗДЕСЬ"  
CITY_ID = "ВАШ_ID_ГОРОДА"                                   

YANDEX_MUSIC_TOKEN = "ВАШ_ЯНДЕКС_МУЗЫКА_ТОКЕН_ЗДЕСЬ" 
MUSIC_API_CHECK_INTERVAL_SEC = 5 
MUSIC_SCROLL_SPEED_SEC = 0.2 
```

### 2.4. Ссылка на файл со всеми ID городов OpenWeatherMap

Список всех городов и их ID, используемых в OpenWeatherMap API, доступен для загрузки:

  * [Список городов OpenWeatherMap (JSON, GZ-архив)](https://www.google.com/url?sa=E&source=gmail&q=https://bulk.openweathermap.org/sample/city.list.json.gz)

Вы можете загрузить этот файл, распаковать его (например, с помощью `gunzip` в Linux или любого архиватора) и найти ID своего города, используя поиск по названию.

### 2.5. Основные функции и логика

  * **`transliterate_cyrillic(text)`**: Преобразует символы кириллицы в латинские эквиваленты.
  * **`get_current_time_and_date_full()`**: Возвращает полную строку с датой и временем (ДД/ММ/ГГ ЧЧ:ММ) для режима ожидания.
  * **`get_current_time_and_date_compact()`**: Возвращает компактную дату (ДД/ММ) и время (ЧЧ:ММ) для режима воспроизведения музыки.
  * **`update_weather_data_func()`**: Запрашивает и обновляет данные о погоде с OpenWeatherMap.
  * **`get_weather_line_for_display()`**: Форматирует строку погоды для вывода на дисплей.
  * **`get_current_track_ym(client_ym, token)`**: Асинхронная функция, которая взаимодействует с Яндекс.Музыкой API для получения информации о текущем треке, включая статус паузы.
  * **`music_status_update_task()`**: Асинхронная задача, которая периодически опрашивает Яндекс.Музыку, обрабатывает полученные данные (включая транслитерацию) и управляет состоянием прокрутки текста.
  * **`arduino_communication_task()`**: Асинхронная задача, которая отвечает за отправку данных на Arduino и прием команд от него. В этой задаче происходит основная логика переключения режимов отображения (`is_playing` или `is_paused`).
  * **`weather_update_task()`**: Асинхронная задача, которая периодически обновляет данные о погоде.
  * **`main()`**: Главная асинхронная функция, которая запускает все остальные асинхронные задачи параллельно.

### 2.6. Как запустить Python-скрипт

1.  **Сохраните код:** Сохраните предоставленный Python-код в файл, например, `display_controller.py`.

2.  **Настройте параметры:** Откройте файл `display_controller.py` и отредактируйте переменные конфигурации, как описано в разделе 2.3.

3.  **Запустите скрипт:** Откройте терминал на вашем мини-ПК, перейдите в директорию с файлом скрипта и запустите его:

    ```bash
    python3 display_controller.py
    ```

4.  **Фоновый режим (опционально):** Если вы хотите, чтобы скрипт работал в фоновом режиме после закрытия терминала, вы можете использовать `nohup` или `screen`/`tmux`:

    ```bash
    nohup python3 display_controller.py &
    ```

    Или

    ```bash
    screen -S display_app
    python3 display_controller.py
    # Затем нажмите Ctrl+A, затем D, чтобы отсоединиться от сессии screen
    ```

    Чтобы снова присоединиться к сессии `screen`, используйте `screen -r display_app`.

## 3\. Arduino-скетч (Общие рекомендации)

Для работы системы вам также потребуется Arduino-скетч, который будет принимать данные по последовательному порту и выводить их на LCD-дисплей.

### 3.1. Предполагаемая функциональность Arduino-скетча:

  * **Инициализация LCD:** Настройка подключения к 16x2 LCD-дисплею (часто через I2C-модуль).
  * **Последовательная связь:** Настройка последовательного порта на той же скорости (`baud_rate`), что и в Python-скрипте.
  * **Чтение данных:** Постоянное чтение входящих данных из последовательного порта.
  * **Парсинг команд:** Предполагается, что Python-скрипт отправляет данные с префиксом `IDLE:` для строк, которые должны отображаться в стандартном режиме. Arduino-скетч должен уметь разбирать эти строки и выводить их на дисплей.
  * **Обработка команд:** Если Arduino имеет кнопки, он может отправлять команды обратно на Python-скрипт (например, `REQ_WEATHER`, `REQ_SYSTEM_STATS`, `REQ_NETWORK_INFO`).

### 3.2. Необходимые библиотеки для Arduino (примерно):

  * `LiquidCrystal_I2C` (если используете I2C-модуль для LCD) или `LiquidCrystal` (для прямого подключения).

### 3.3. Общие шаги по настройке Arduino:

1.  **Подключите LCD-дисплей** к Arduino согласно схеме подключения (либо по I2C, либо по прямым пинам).
2.  **Напишите Arduino-скетч**, который инициализирует LCD, настраивает последовательную связь и в цикле `loop()` читает данные из последовательного порта, затем отображает их на LCD. Убедитесь, что скорость последовательного порта (`Serial.begin(baud_rate)`) совпадает с Python-скриптом.
3.  **Загрузите скетч** на ваш Arduino с помощью Arduino IDE.
